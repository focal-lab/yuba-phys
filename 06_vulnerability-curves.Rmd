---
title: "06_PLC"
author: "Anjum K. Gujral"
date: '2024-08-25'
output: html_document
---

```{r}
install.packages('janitor')
library(janitor)
install.packages('here')
library(here)
install.packages('lubridate')
library(lubridate)
install.packages('readxl')
library(readxl)
library(gridExtra)
library(MetBrewer)
library(dlookr)
install.packages('beeswarm')
library(beeswarm)
library(tidyverse)
geom_beeswarm = ggbeeswarm::geom_beeswarm()
here = here::here()
library(scales)
library(gridExtra)
library(ggrepel)
library(boot)
library(devtools)
library(fitplc)
library(dplyr)

```

```{r}
DATADIR = "/Users/anjumgujral/Box Sync/yuba-phys_data/P50"

cavitron_files <- list.files(path = here::here("P50", "P50_individual"), pattern = "*.csv", full.names = TRUE, include.dirs = T, recursive = T) 

# Read and combine CSV files
all_cavitron_data<- cavitron_files %>%
  map_dfr(~read_csv(.x, skip = 1, col_names = read_csv(.x, n_max = 1)))


# Assuming you have a combined dataframe called combined_data

# Initialize an empty list to store individual dataframes
dataframes <- list()

# Initialize a variable to keep track of the current header
current_header <- NULL

some_condition <- function(row) {
  # Check if the first cell in the row contains "Date_time" (case insensitive)
  first_cell <- as.character(row[1])
  return(grepl("Date_time", first_cell, ignore.case = TRUE))
}

# Loop through rows in combined_data
for (i in 1:nrow(all_cavitron_data)) {
  # Check if the current row could be a header (you can customize this condition)
  if (some_condition(all_cavitron_data[i, ])) {
    # Set the current row as the column names
    current_header <- as.character(all_cavitron_data[i, ])
  } else {
    # If it's not a header, create a new dataframe and add it to the list
    if (!is.null(current_header)) {
      dataframes <- append(dataframes, list(
        setNames(all_cavitron_data[i, , drop = FALSE], current_header)
      ))
    }
  }
}

# Combine all the individual dataframes into one
cavitron_df <- do.call(rbind, dataframes) %>% 
  janitor::clean_names() 

vc_all <- cavitron_df %>% 
  janitor::clean_names() %>% 
  drop_na(campaign_name) %>% 
  dplyr::mutate( 
         tree = as.numeric(sample_ref_1), 
         #branch = sample_ref_2,
         mpa = as.numeric(pressure_mpa) * -1,
         pressures = mpa,
         neg_mpa = as.numeric(pressure_mpa),
        k = as.numeric(raw_conductance_kg_mpa_s),           #raw stem hydraulic conductance
        kstem_length = as.numeric(conductivity_si_corr_t),  #hydraulic conductivity per stem length 
        #stem_id = paste(site, tree, branch, sep = "-"),
        plc_new = as.numeric(plc),
        #species = case_when(
    #species %in% c("Abies concolor") ~ "ABCO", 
    #species %in% c("Pinus lambertiana") ~ "PILA", 
    #species %in% c("Calocedrus decurrens") ~ "CADE", 
    #TRUE ~ as.character(species)), 
    type = case_when(speed_class %in% c("a") ~ "kmax", #maximum conductivity point (from speed class "a")
                     speed_class %in% c("b", "c","d", "e", "f", "g", "h", "i") ~ "VC", 
      TRUE ~ as.character(speed_class))) %>%  # everything else = speed classes "b" to "i")
  select(tree, mpa, neg_mpa, k, kstem_length, plc_new, type) %>% 
  mutate(size = as.factor("B"), 
         plc_new = case_when(  #set bounds for PLC new from 0-100
           plc_new < 0 ~ 0, 
           plc_new > 100 ~ 100,
           TRUE ~ as.numeric(plc_new)
         )) %>% 
  drop_na(plc_new)

vc_all2 <- vc_all %>% 
  group_by(tree) %>% 
  mutate(group = case_when(
    mpa == min(mpa) ~ "a",              #if mpa is the minimum mpa for that tree, assign group "a" (kmax)
    TRUE ~ as.character("b"))) %>%      #otherwise assign it to group "b"
  group_by(tree) %>% 
  mutate(mean_kstem_a = mean(kstem_length[group == 'a'], na.rm = T)) %>%  # mean of the kmax values
  ungroup() %>% 
  mutate(plc_new = 100-(100*kstem_length/mean_kstem_a))%>%   #calculate PLC from 
  drop_na(plc_new)

#save all raw vulnerability curve data
# note: there are duplicates in here, come back to clean later
write.csv(vc_all2, file = "yuba-phys-vulnerability-curve-raw-data-2024.csv", row.names = FALSE)

```

```{r}
#Have to do each tree individually and remove the ones that do not work: 

stemID <- subset(vc_all2, vc_all2$tree =="209.1")
# Convert all numeric columns to avoid scientific notation
#stemID <- stemID %>%
  #mutate(k = format(k, scientific = FALSE))
#pfit <- fitplc(stemID, varnames=c(PLC="plc_new", WP="mpa"), nboot=50)

stemID <- stemID %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  # Create valid_data based on plc_new >= 0

# Fit the model using only rows where plc_new >= 0
pfit <- fitplc(stemID %>% filter(valid_data == TRUE), varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 50)

# Plot the fitted model
plot(pfit, 
     xlim = c(0,7),
     ylim = c(0,1))

# Access the fitted coefficients
coefficients <- coef(pfit)
print(coefficients)
```

```{r}
vc_all_2024_2_cleaned <- data.frame()
vc_all_2024_2_cleaned <- tibble()

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, stemID)

```

#PILA P50
##PILA -- low elevation 
```{r}
PILA_low_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("177", "5001","5007","207")))

PILA_low_sun_seedling <- PILA_low_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PILA_low_sun_seedling <- PILA_low_sun_seedling %>% filter(valid_data == TRUE)

PILA_low_sun_seedling_cleaned <- 
  PILA_low_sun_seedling %>%  filter(!row_number() %in% c(2, 4, 6, 8, 16, 17, 18, 19, 38, 42, 44, 45, 49, 55, 60, 62, 64, 68))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_low_sun_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA low elevation, sun exposed seedling",
     legend = TRUE,
     xlim = c(0.5, 5.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

#output:   
#mean_P50 mean_lwr mean_upr
#3.946345 3.890444 3.994102

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_low_sun_seedling_cleaned)
```

```{r}
PILA_low_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("31", "151.1", "5010", "5011")))
  
PILA_low_shade_seedling <- PILA_low_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PILA_low_shade_seedling <- PILA_low_shade_seedling %>% filter(valid_data == TRUE)

PILA_low_shade_seedling_cleaned <- 
  PILA_low_shade_seedling %>%  filter(!row_number() %in% c(4, 7, 8, 9, 12, 19, 26, 27, 29, 30, 31, 66, 67, 70, 74, 89, 91, 93, 94, 95, 96, 105, 106, 108, 109, 110))

PILA_low_shade_seedling_cleaned <- 
  PILA_low_shade_seedling_cleaned %>%  filter(!row_number() %in% c(89-12))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_low_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA low elevation, shaded seedling",
     legend = FALSE,
     xlim = c(0.5, 6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.420236 3.346096 3.491153

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_low_shade_seedling_cleaned)
```

```{r}
PILA_low_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("202.2", "23.2")))

#202.1 <- curve is fine but unrealistic value (-5), maybe cuvette broke

PILA_low_sun_sapling <- PILA_low_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_low_sun_sapling <- PILA_low_sun_sapling %>% filter(valid_data == TRUE)

PILA_low_sun_sapling_cleaned <- 
  PILA_low_sun_sapling %>%  filter(!row_number() %in% c(20, 33, 38))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_low_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA low elevation, sun exposed sapling",
     legend = TRUE,
     xlim = c(0.5, 6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.035791 3.884941 4.045471

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_low_sun_sapling_cleaned)

```

```{r}
PILA_low_shade_sapling <-vc_all2 %>% 
  filter((tree %in% c("8.1","8.2", "43.2", "46.1", "46.2", "170.1")))

# 170.2 
#43.2

PILA_low_shade_sapling <- PILA_low_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_low_shade_sapling <- PILA_low_shade_sapling %>% filter(valid_data == TRUE)

PILA_low_shade_sapling_cleaned <- 
  PILA_low_shade_sapling %>%  filter(!row_number() %in% c(8, 165, 166, 168, 204))
 
# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_low_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA low elevation, shaded sapling",
     legend = FALSE,
     xlim = c(0.5,5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.096779 3.066328 3.126015

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_low_shade_sapling_cleaned)
```

## PILA -- mid elevation

```{r}
PILA_mid_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("177","207")))

PILA_mid_sun_seedling <- PILA_mid_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PILA_mid_sun_seedling <- PILA_mid_sun_seedling %>% filter(valid_data == TRUE)

#PILA_mid_sun_seedling_cleaned <- 
  #PILA_mid_sun_seedling %>%  filter(!row_number() %in% c(2, 4, 6, 8, 16, 17, 18, 19, 38, 42, 44, 45, 49, 55, 60, 62, 64, 68))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_mid_sun_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA mid elevation, sun exposed seedling",
     legend = TRUE,
     xlim = c(0.5, 5.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

#output:   
#mean_P50 mean_lwr mean_upr
#3.84496 3.480961 3.910347
```

```{r}
PILA_mid_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("31","5011", "151.1", "5014")))
  
PILA_mid_shade_seedling <- PILA_mid_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PILA_mid_shade_seedling <- PILA_mid_shade_seedling %>% filter(valid_data == TRUE)

PILA_mid_shade_seedling_cleaned <- 
  PILA_mid_shade_seedling %>%  filter(!row_number() %in% c(4, 7, 8, 9, 12, 19, 26, 27, 29, 30, 31, 66, 67, 70, 74, 89, 91, 93, 94, 95, 96, 105, 106, 108, 109, 110))

PILA_mid_shade_seedling_cleaned <- 
  PILA_mid_shade_seedling_cleaned %>%  filter(!row_number() %in% c(89-12))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_mid_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA mid elevation, shaded seedling",
     legend = FALSE,
     xlim = c(0.5, 6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.411819 3.223902  3.58093

```

```{r}
PILA_mid_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("")))

#202.1 <- curve is fine but unrealistic value (-5), maybe cuvette broke

PILA_mid_sun_sapling <- PILA_mid_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_mid_sun_sapling <- PILA_mid_sun_sapling %>% filter(valid_data == TRUE)

PILA_mid_sun_sapling_cleaned <- 
  PILA_mid_sun_sapling %>%  filter(!row_number() %in% c(20, 33, 38))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_mid_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA mid elevation, sun exposed sapling",
     legend = TRUE,
     xlim = c(0.5, 6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr


```

```{r}
PILA_mid_shade_sapling <-vc_all2 %>% 
  filter((tree %in% c("170.1", "46.1", "46.2", "43.2")))

# 170.2 
#43.2

PILA_mid_shade_sapling <- PILA_mid_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_mid_shade_sapling <- PILA_mid_shade_sapling %>% filter(valid_data == TRUE)

PILA_mid_shade_sapling_cleaned <- 
  PILA_mid_shade_sapling %>%  filter(!row_number() %in% c(8, 165, 166, 168, 204))
 
# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_mid_shade_sapling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA mid elevation, shaded sapling",
     legend = FALSE,
     xlim = c(0.5,5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.192601 3.140481  3.24566
```


##PILA -- high elevation 
```{r}
PILA_high_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("267", "243","301")))

PILA_high_sun_seedling <- PILA_high_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PILA_high_sun_seedling <- PILA_high_sun_seedling %>% filter(valid_data == TRUE)

PILA_high_sun_seedling_cleaned <- 
  PILA_high_sun_seedling %>%  filter(!row_number() %in% c(22, 23, 27, 28, 33))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_high_sun_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA high elevation, sun exposed seedling",
     legend = TRUE,
     xlim = c(0.5,6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

#  mean_P50 mean_lwr mean_upr
# 3.980955 3.872629 4.055284

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_high_sun_seedling_cleaned)
```

```{r}
PILA_high_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("133", "279", "292")))

#254.1

PILA_high_shade_seedling <- PILA_high_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_high_shade_seedling <- PILA_high_shade_seedling %>% filter(valid_data == TRUE)

PILA_high_shade_seedling_cleaned <- 
  PILA_high_shade_seedling %>%  filter(!row_number() %in% c(1, 2, 3, 4, 5, 8, 9, 10, 11, 23, 42, 45, 46, 63, 64,65, 67, 68, 70, 71, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 87, 96, 102, 103, 105))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_high_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA high elevation, shaded seedling",
     legend = TRUE,
     xlim = c(0.5,6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.949126 3.861037 4.002805

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_high_shade_seedling_cleaned)
```

```{r}
PILA_high_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("216.1", "216.2", "266.2", "248.1","293.1", "266.1")))

# 248.2, 266.1

PILA_high_sun_sapling <- PILA_high_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_high_sun_sapling <- PILA_high_sun_sapling %>% filter(valid_data == TRUE)

PILA_high_sun_sapling_cleaned <- 
  PILA_high_sun_sapling %>%  filter(!row_number() %in% c(40,42, 97, 70, 71, 103, 104))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_high_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA high elevation, sun exposed sapling",
     legend = FALSE,
     xlim = c(0.5,6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.405015 3.353651 3.447618

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_high_sun_sapling_cleaned)
```

```{r}
PILA_high_shade_sapling <-vc_all2 %>% 
  filter((tree %in% c("239.1", "286.1", "284.1")))

# "143.1",  "83.1", 

PILA_high_shade_sapling <- PILA_high_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PILA_high_shade_sapling <- PILA_high_shade_sapling %>% filter(valid_data == TRUE)

PILA_high_shade_sapling_cleaned <- 
  PILA_high_shade_sapling %>%  filter(!row_number() %in% c(1,2, 19, 20, 21, 22, 23, 24, 25,30,31, 45, 50, 52, 59, 61))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PILA_high_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PILA high elevation, shaded sapling",
     legend = TRUE,
     ylim = c(0,1),
     xlim = c(0.5,6))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.378291 3.197237 3.415031

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PILA_high_shade_sapling_cleaned)
```


#PIPO P50
##PIPO-- low elevation 
```{r}
PIPO_low_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("5003","5004","5009")))

PIPO_low_sun_seedling <- PIPO_low_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PIPO_low_sun_seedling <- PIPO_low_sun_seedling %>% filter(valid_data == TRUE)

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_low_sun_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO low elevation, sun exposed seedling",
     legend = TRUE)

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_low_sun_seedling)
```

```{r}
PIPO_low_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("")))

#162
  
PIPO_low_shade_seedling <- PIPO_low_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_low_shade_seedling <- PIPO_low_shade_seedling %>% filter(valid_data == TRUE)

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_low_shade_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO low elevation, shaded seedling",
     legend = FALSE,
     xlim = c(0.5,6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.587392 4.543307 4.633422

```

```{r}
PIPO_low_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("10.2", "24.1", "24.2", "180.1", "180.2")))

#10.1

PIPO_low_sun_sapling <- PIPO_low_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_low_sun_sapling <- PIPO_low_sun_sapling %>% filter(valid_data == TRUE)

PIPO_low_sun_sapling_cleaned <- 
  PIPO_low_sun_sapling %>%  filter(!row_number() %in% c(5, 56, 57, 61, 87, 120, 122, 123, 131, 132, 133, 144, 145, 146, 147, 148, 151, 152))

PIPO_low_sun_sapling_cleaned <- PIPO_low_sun_sapling_cleaned[32:161, ]

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_low_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO low elevation, sun exposed sapling",
     legend = FALSE,
     xlim = c(0.5,6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.244883 4.205137 4.280323

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_low_sun_sapling_cleaned)

```

```{r}
PIPO_low_shade_sapling <-vc_all2 %>% 
  filter((tree %in% c("34.2","178.1", "55.2")))

#45.1, 45.2

PIPO_low_shade_sapling <- PIPO_low_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_low_shade_sapling <- PIPO_low_shade_sapling %>% filter(valid_data == TRUE)

PIPO_low_shade_sapling_cleaned <- 
  PIPO_low_shade_sapling %>%  filter(!row_number() %in% c(4, 23, 28, 48))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_low_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO low elevation, shaded sapling",
     legend = FALSE,
     xlim= c(0.5,6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.198861 4.143742 4.252357

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_low_shade_sapling_cleaned)


```

##PIPO -- mid elevation 
```{r}
PIPO_mid_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("")))

PIPO_mid_sun_seedling <- PIPO_mid_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PIPO_mid_sun_seedling <- PIPO_mid_sun_seedling %>% filter(valid_data == TRUE)

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_mid_sun_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO mid elevation, sun exposed seedling",
     legend = TRUE)

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))
```

```{r}
PIPO_mid_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("5012")))

#162
  
PIPO_mid_shade_seedling <- PIPO_mid_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_mid_shade_seedling <- PIPO_mid_shade_seedling %>% filter(valid_data == TRUE)

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_mid_shade_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO mid elevation, shaded seedling",
     legend = FALSE,
     xlim = c(0.5,6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.587392 4.538742 4.636312

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_mid_shade_seedling)

```

```{r}
PIPO_mid_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("")))

#10.1

PIPO_mid_sun_sapling <- PIPO_mid_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_mid_sun_sapling <- PIPO_mid_sun_sapling %>% filter(valid_data == TRUE)

#PIPO_mid_sun_sapling_cleaned <- 
  #PIPO_mid_sun_sapling %>%  filter(!row_number() %in% c(5, 56, 57, 61, 87, 120, 122, 123, 131, 132, 133, 144, 145, 146, 147, 148, 151, 152))

#PIPO_mid_sun_sapling_cleaned <- PIPO_mid_sun_sapling_cleaned[32:161, ]

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_mid_sun_sapling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO mid elevation, sun exposed sapling",
     legend = TRUE,
     xlim = c(0.5,6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.208922 4.166699 4.247342
```

```{r}
PIPO_mid_shade_sapling <-vc_all2 %>% 
  filter((tree %in% c()))
#119.1
#45.1, 45.2

PIPO_mid_shade_sapling <- PIPO_mid_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_mid_shade_sapling <- PIPO_mid_shade_sapling %>% filter(valid_data == TRUE)

#PIPO_mid_shade_sapling_cleaned <- 
  #PIPO_mid_shade_sapling %>%  filter(!row_number() %in% c(4, 28, 48))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_mid_shade_sapling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO mid elevation, shaded sapling",
     legend = TRUE,
     xlim= c(0.5,6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.198465 4.152122  4.27435
```

##PIPO-- high elevation 
```{r}
PIPO_high_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("217", "300", "277")))

#138, 277

PIPO_high_sun_seedling <- PIPO_high_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PIPO_high_sun_seedling <- PIPO_high_sun_seedling %>% filter(valid_data == TRUE)

PIPO_high_sun_seedling_cleaned <- 
  PIPO_high_sun_seedling %>%  filter(!row_number() %in% c(8, 23, 24, 25, 28, 30))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_high_sun_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO high elevation, sun exposed seedling",
     legend = TRUE)

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.19564 4.102608 4.239264

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_high_sun_seedling_cleaned)

```

```{r}
PIPO_high_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("288.1","294.1")))
  
PIPO_high_shade_seedling <- PIPO_high_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_high_shade_seedling <- PIPO_high_shade_seedling %>% filter(valid_data == TRUE)

PIPO_high_shade_seedling_cleaned <- 
  PIPO_high_shade_seedling %>%  filter(!row_number() %in% c(1, 6, 7, 9, 15, 21, 25, 27, 28))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_high_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO high elevation, shaded seedling",
     legend = TRUE,
     xlim = c(0.5, 6),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.933056 3.880984 3.996827

# attach these cleaned curves to the cleaned dataframe
vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_high_shade_seedling_cleaned)
```

```{r}
PIPO_high_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("146.1", "226.2", "237.1")))

#146.2, 274.1, 274.2

PIPO_high_sun_sapling <- PIPO_high_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_high_sun_sapling <- PIPO_high_sun_sapling %>% filter(valid_data == TRUE)

PIPO_high_sun_sapling_cleaned <- 
  PIPO_high_sun_sapling %>%  filter(!row_number() %in% c(31))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_high_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO high elevation, sun exposed sapling",
     legend = TRUE)

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.043665 3.906704 4.095981

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_high_sun_sapling_cleaned)

```

```{r}
PIPO_high_shade_sapling <-vc_all2 %>% 
  filter((tree %in% c("258.1", "296.2")))

#296.1

PIPO_high_shade_sapling <- PIPO_high_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
PIPO_high_shade_sapling <- PIPO_high_shade_sapling %>% filter(valid_data == TRUE)

PIPO_high_shade_sapling_cleaned <- 
  PIPO_high_shade_sapling %>%  filter(!row_number() %in% c(1))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PIPO_high_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "PIPO high elevation, shaded sapling",
     legend = TRUE, 
     ylim = c(0,1),
     xlim = c(0.5, 6))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.463569 3.417393 3.552126

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, PIPO_high_shade_sapling_cleaned)

```

#ABCO P50
##ABCO -- low elevation
```{r}
ABCO_low_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("164", "167", "5008")))

ABCO_low_sun_seedling <- ABCO_low_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

ABCO_low_sun_seedling <- ABCO_low_sun_seedling %>% filter(valid_data == TRUE)

ABCO_low_sun_seedling_cleaned <- 
  ABCO_low_sun_seedling %>%  filter(!row_number() %in% c(1, 5, 44, 45, 65))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_low_sun_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO low elevation, sun exposed seedling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.584102 4.421904 4.625231

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_low_sun_seedling_cleaned)
```

```{r}
ABCO_low_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("33" , "153", "5006")))


#5002 <- good curve but very low P50 (-5.5), maybe cuvette broke?
  
ABCO_low_shade_seedling <- ABCO_low_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_low_shade_seedling <- ABCO_low_shade_seedling %>% filter(valid_data == TRUE)

ABCO_low_shade_seedling_cleaned <-   ABCO_low_shade_seedling %>%  filter(!row_number() %in% c(5, 6, 7, 8, 18, 20, 21, 22, 68))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_low_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO low elevation, shaded seedling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
#4.48222  4.37921 4.543011

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_low_shade_seedling_cleaned)

```

```{r}
ABCO_low_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("150.1" ,"186.1", "186.2", "200.1", "209.1")))

#102.1, 
#200.2 <- good curve but needs kmax reassigned

ABCO_low_sun_sapling <- ABCO_low_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_low_sun_sapling <- ABCO_low_sun_sapling %>% filter(valid_data == TRUE)

ABCO_low_sun_sapling_cleaned <-   ABCO_low_sun_sapling %>%  filter(!row_number() %in% c(2, 18, 20, 102))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_low_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO low elevation, sun exposed sapling",
     legend = TRUE, 
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.486094 4.415758 4.546265

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_low_sun_sapling_cleaned)

```

```{r}
ABCO_low_shade_sapling <-vc_all2 %>% 
  filter(tree %in% c())

#5, 175.1

ABCO_low_shade_sapling <- ABCO_low_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_low_shade_sapling <- ABCO_low_shade_sapling %>% filter(valid_data == TRUE)

ABCO_low_shade_sapling_cleaned <- ABCO_low_shade_sapling %>%  filter(!row_number() %in% c(34, 38, 39, 47, 51, 52, 61, 110))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_low_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO low elevation, shaded sapling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))
```

##ABCO -- mid elevation 
```{r}
ABCO_mid_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("167","164")))

ABCO_mid_sun_seedling <- ABCO_mid_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

ABCO_mid_sun_seedling <- ABCO_mid_sun_seedling %>% filter(valid_data == TRUE)

#ABCO_mid_sun_seedling_cleaned <- 
  #ABCO_mid_sun_seedling %>%  filter(!row_number() %in% c(1, 5, 44, 45, 65))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_mid_sun_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO mid elevation, sun exposed seedling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.560148 4.544987 4.665296
```

```{r}
ABCO_mid_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("33", "153")))

#5002 <- good curve but very low P50 (-5.5), maybe cuvette broke?
  
ABCO_mid_shade_seedling <- ABCO_mid_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_mid_shade_seedling <- ABCO_mid_shade_seedling %>% filter(valid_data == TRUE)

#ABCO_mid_shade_seedling_cleaned <-   ABCO_mid_shade_seedling %>%  filter(!row_number() %in% c(5, 6, 7, 8, 18, 20, 21, 22, 68))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_mid_shade_seedling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO mid elevation, shaded seedling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.938106 3.78903 4.118799
```

```{r}
ABCO_mid_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("150.1", "209.1", "200.1")))

#102.1, 
#200.2 <- good curve but needs kmax reassigned

ABCO_mid_sun_sapling <- ABCO_mid_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_mid_sun_sapling <- ABCO_mid_sun_sapling %>% filter(valid_data == TRUE)

#ABCO_mid_sun_sapling_cleaned <-   ABCO_mid_sun_sapling %>%  filter(!row_number() %in% c(2, 18, 20, 102))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_mid_sun_sapling, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO mid elevation, sun exposed sapling",
     legend = TRUE, 
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.400005 4.308336 4.459973

```

```{r}
ABCO_mid_shade_sapling <-vc_all2 %>% 
  filter(tree %in% c("175.1", "175.2", "40.1", "40.2","40.3", "51.1","51.2", "118.1", "199.1","199.2"))

#5, 175.1

ABCO_mid_shade_sapling <- ABCO_mid_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_mid_shade_sapling <- ABCO_mid_shade_sapling %>% filter(valid_data == TRUE)

ABCO_mid_shade_sapling_cleaned <- ABCO_mid_shade_sapling %>%  filter(!row_number() %in% c(34, 38, 39, 47, 51, 52, 61, 110))


# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_mid_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO mid elevation, shaded sapling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.020843  3.96401 4.072884

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_mid_shade_sapling_cleaned)

```


##ABCO -- high elevation 
```{r}
ABCO_high_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("125.1", "247", "137.1")))

# 271

ABCO_high_sun_seedling <- ABCO_high_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

ABCO_high_sun_seedling <- ABCO_high_sun_seedling %>% filter(valid_data == TRUE)

ABCO_high_sun_seedling_cleaned <- ABCO_high_sun_seedling %>%  filter(!row_number() %in% c(5, 8, 16, 19, 24, 25, 26, 27, 28, 33, 37, 52, 57,61,62,65,66))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_high_sun_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO high elevation, sun exposed seedling",
     legend = TRUE,
     xlim = c(0.5,7.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.39191 4.245323 4.686521

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_high_sun_seedling_cleaned)

```

```{r}
ABCO_high_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("128")))

#282
  
ABCO_high_shade_seedling <- ABCO_high_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_high_shade_seedling <- ABCO_high_shade_seedling %>% filter(valid_data == TRUE)

ABCO_high_shade_seedling_cleaned <- ABCO_high_shade_seedling %>%  filter(!row_number() %in% c(1, 17, 18, 21, 22, 23, 28, 29, 32, 33, 35))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_high_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO high elevation, shaded seedling",
     legend = TRUE,
     xlim = c(1,6.5),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.419759 4.396273 4.511261

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_high_shade_seedling_cleaned)

```

```{r}
ABCO_high_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("235.2", "220.1", "297.1", "276.2")))

#235.1, 276.1 :(

ABCO_high_sun_sapling <- ABCO_high_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_high_sun_sapling <- ABCO_high_sun_sapling %>% filter(valid_data == TRUE)

ABCO_high_sun_sapling_cleaned <- ABCO_high_sun_sapling %>%  filter(!row_number() %in% c(2,3,4,5,6,7,8,9, 24, 26, 33, 34, 35, 36, 38))


# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_high_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO high elevation, sun exposed sapling",
     legend = TRUE,
     xlim= c(0.5, 7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.777402 3.648038 3.895114

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_high_sun_sapling_cleaned)

```

```{r}
ABCO_high_shade_sapling <-vc_all2 %>% 
  filter(tree %in% c("60.1","281", "307.1"))

#"85.1" <- useable but needs kmax reassigned 

ABCO_high_shade_sapling <- ABCO_high_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABCO_high_shade_sapling <- ABCO_high_shade_sapling %>% filter(valid_data == TRUE)

ABCO_high_shade_sapling_cleaned <- ABCO_high_shade_sapling %>%  filter(!row_number() %in% c(1, 2, 4, 26, 27, 33, 36, 37, 38, 39, 43, 70, 81, 82, 83, 84, 88, 89))


# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABCO_high_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABCO high elevation, shaded sapling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.04298 3.940145 4.111902

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABCO_high_shade_sapling_cleaned)

```

#ABMA P50
##ABMA -- high elevation
```{r}
ABMA_high_sun_seedling <- vc_all2 %>% 
  filter((tree %in% c("71.1", "291")))

ABMA_high_sun_seedling <- ABMA_high_sun_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

ABMA_high_sun_seedling <- ABMA_high_sun_seedling %>% filter(valid_data == TRUE)

ABMA_high_sun_seedling_cleaned <- ABMA_high_sun_seedling %>%  filter(!row_number() %in% c(1, 3,4,5,6,7,8,9,10,11, 16,18,19,21,22,23, 36))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABMA_high_sun_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABMA high elevation, sun exposed seedling",
     legend = TRUE)

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.241517 4.172947 4.279737

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABMA_high_sun_seedling_cleaned)

```

```{r}
ABMA_high_shade_seedling <- vc_all2 %>% 
  filter((tree %in% c("136.1", "136.2")))

#240.1, 136.2

ABMA_high_shade_seedling <- ABMA_high_shade_seedling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABMA_high_shade_seedling <- ABMA_high_shade_seedling %>% filter(valid_data == TRUE)

ABMA_high_shade_seedling_cleaned <- 
  ABMA_high_shade_seedling %>%  filter(!row_number() %in% c(2, 3, 8, 11, 14, 15, 16, 18, 19, 21, 22, 23, 24, 26, 28, 29, 30, 33, 34, 38, 42, 43, 45, 46, 47, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABMA_high_shade_seedling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)


coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABMA high elevation, shaded seedling",
     legend = TRUE)

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.337336  4.28198 4.447232

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABMA_high_shade_seedling_cleaned)

```

```{r}
ABMA_high_sun_sapling <-vc_all2 %>% 
  filter((tree %in% c("273.2", "233.1","290.1", "215.1")))

#215.1
#273.1 <- still useable 

ABMA_high_sun_sapling <- ABMA_high_sun_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABMA_high_sun_sapling <- ABMA_high_sun_sapling %>% filter(valid_data == TRUE)

ABMA_high_sun_sapling_cleaned <- 
  ABMA_high_sun_sapling %>%  filter(!row_number() %in% c(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 30, 52, 53, 64, 67, 76))

#24, 25, 36, 39, 48, 50

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABMA_high_sun_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABMA high elevation, sun exposed sapling",
     legend = TRUE,
     xlim = c(0.5,7),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 4.132574 4.046866 4.181001

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABMA_high_sun_sapling_cleaned)

```

```{r}
ABMA_high_shade_sapling <-vc_all2 %>% 
  filter(tree %in% c("280.2", "308.1"))

#280.1

ABMA_high_shade_sapling <- ABMA_high_shade_sapling %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  
ABMA_high_shade_sapling <- ABMA_high_shade_sapling %>% filter(valid_data == TRUE)

ABMA_high_shade_sapling_cleaned <- 
  ABMA_high_shade_sapling %>%  filter(!row_number() %in% c(9, 20, 21, 22, 27, 39, 46, 47))

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(ABMA_high_shade_sapling_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "ABMA high elevation, shaded sapling",
     legend = TRUE,
     xlim = c(0.5,7))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))

# mean_P50 mean_lwr mean_upr
# 3.635542 3.421669 3.904172

vc_all_2024_2_cleaned <- bind_rows(vc_all_2024_2_cleaned, ABMA_high_shade_sapling_cleaned)
```
#2024 cleaned df
```{r}
write.csv(vc_all_2024_2_cleaned,"yuba-phys-vulnerability-curve-cleaned-data-2024.csv", row.names = FALSE)
```

#species, site, size means
```{R}
trait_data1 <- trait_data1 %>%
  mutate(P50_mean = case_when(
    size == "seedling" & microsite == "sun"   & species == "ABCO" & elevation == "high" ~ 4.39,
    size == "seedling" & microsite == "int"   & species == "ABCO" & elevation == "high" ~ 4.40,
    size == "seedling" & microsite == "shade" & species == "ABCO" & elevation == "high" ~ 4.42,
    size == "seedling" & microsite == "sun"   & species == "ABCO" & elevation == "low" ~ 4.58,
    size == "seedling" & microsite == "int" & species == "ABCO" & elevation == "low" ~ 4.53,
    size == "seedling" & microsite == "shade" & species == "ABCO" & elevation == "low" ~ 4.48,
    size == "seedling" & microsite == "sun"   & species == "ABCO" & elevation == "mid" ~ 4.56,
    size == "seedling" & microsite == "int" & species == "ABCO" & elevation == "mid" ~ 4.245,
    size == "seedling" & microsite == "shade" & species == "ABCO" & elevation == "mid" ~ 3.93,
    
    size == "sapling" & microsite == "sun"   & species == "ABCO" & elevation == "high" ~ 3.77,
    size == "sapling" & microsite == "int"   & species == "ABCO" & elevation == "high" ~ 3.9,
    size == "sapling" & microsite == "shade" & species == "ABCO" & elevation == "high" ~ 4.04,
    size == "sapling" & microsite == "sun"   & species == "ABCO" & elevation == "low" ~ 4.48,
    size == "sapling" & microsite == "int"   & species == "ABCO" & elevation == "low" ~ 4.25,
    size == "sapling" & microsite == "shade" & species == "ABCO" & elevation == "low" ~ 4.02,
    size == "sapling" & microsite == "sun"   & species == "ABCO" & elevation == "mid" ~ 4.40,
    size == "sapling" & microsite == "int" & species == "ABCO" & elevation == "mid" ~ 4.21,
    size == "sapling" & microsite == "shade" & species == "ABCO" & elevation == "mid" ~ 4.02,
    
    
    size == "seedling" & microsite == "sun"   & species == "PILA" & elevation == "high" ~ 3.98,
    size == "seedling" & microsite == "int" & species == "PILA" & elevation == "high" ~ 3.96,
    size == "seedling" & microsite == "shade" & species == "PILA" & elevation == "high" ~ 3.94,
    size == "seedling" & microsite == "sun"   & species == "PILA" & elevation == "low" ~ 3.94,
    size == "seedling" & microsite == "int" & species == "PILA" & elevation == "low" ~ 3.68,
    size == "seedling" & microsite == "shade" & species == "PILA" & elevation == "low" ~ 3.42,
    size == "seedling" & microsite == "sun"   & species == "PILA" & elevation == "mid" ~ 3.84,
    size == "seedling" & microsite == "int" & species == "PILA" & elevation == "mid" ~ 3.62,
    size == "seedling" & microsite == "shade" & species == "PILA" & elevation == "mid" ~ 3.41,
    
    size == "sapling" & microsite == "sun"   & species == "PILA" & elevation == "high" ~ 3.40,
    size == "sapling" & microsite == "int"   & species == "PILA" & elevation == "high" ~ 3.38,
    size == "sapling" & microsite == "shade" & species == "PILA" & elevation == "high" ~ 3.37,
    size == "sapling" & microsite == "sun"   & species == "PILA" & elevation == "low" ~ 4.03,
    size == "sapling" & microsite == "int" & species == "PILA" & elevation == "low" ~ 3.56,
    size == "sapling" & microsite == "shade" & species == "PILA" & elevation == "low" ~ 3.09,
    size == "sapling" & microsite == "sun"   & species == "PILA" & elevation == "mid" ~ 4.03,
    size == "sapling" & microsite == "int" & species == "PILA" & elevation == "mid" ~ 3.61,
    size == "sapling" & microsite == "shade" & species == "PILA" & elevation == "mid" ~ 3.19,
    
    
    size == "seedling" & microsite == "sun"   & species == "PIPO" & elevation == "high" ~ 4.19,
    size == "seedling" & microsite == "int" & species == "PIPO" & elevation == "high" ~ 4.06,
    size == "seedling" & microsite == "shade" & species == "PIPO" & elevation == "high" ~ 3.93,
    size == "seedling" & microsite == "sun"   & species == "PIPO" & elevation == "low" ~ 4.5,
    size == "seedling" & microsite == "int" & species == "PIPO" & elevation == "low" ~ 4.54,
    size == "seedling" & microsite == "shade" & species == "PIPO" & elevation == "low" ~ 4.58,
    size == "seedling" & microsite == "sun"   & species == "PIPO" & elevation == "mid" ~ 4.5,
    size == "seedling" & microsite == "int" & species == "PIPO" & elevation == "mid" ~ 4.54,
    size == "seedling" & microsite == "shade" & species == "PIPO" & elevation == "mid" ~ 4.58,
    
    size == "sapling" & microsite == "sun"   & species == "PIPO" & elevation == "high" ~ 4.04,
    size == "sapling" & microsite == "int" & species == "PIPO" & elevation == "high" ~ 3.75,
    size == "sapling" & microsite == "shade" & species == "PIPO" & elevation == "high" ~ 3.46,
    size == "sapling" & microsite == "sun"   & species == "PIPO" & elevation == "low" ~ 4.24,
    size == "sapling" & microsite == "int" & species == "PIPO" & elevation == "low" ~ 4.21,
    size == "sapling" & microsite == "shade" & species == "PIPO" & elevation == "low" ~ 4.19,
    size == "sapling" & microsite == "sun"   & species == "PIPO" & elevation == "mid" ~ 4.21,
    size == "sapling" & microsite == "int" & species == "PIPO" & elevation == "mid" ~ 4.20,
    size == "sapling" & microsite == "shade" & species == "PIPO" & elevation == "mid" ~ 4.19,
    
    size == "seedling" & microsite == "sun"   & species == "ABMA" & elevation == "high" ~ 4.24,
    size == "seedling" & microsite == "int" & species == "ABMA" & elevation == "high" ~ 4.28,
    size == "seedling" & microsite == "shade" & species == "ABMA" & elevation == "high" ~ 4.33,
    size == "sapling" & microsite == "sun"   & species == "ABMA" & elevation == "high" ~ 4.13,
    size == "sapling" & microsite == "int" & species == "ABMA" & elevation == "high" ~ 3.88,
    size == "sapling" & microsite == "shade" & species == "ABMA" & elevation == "high" ~ 3.63,
    TRUE ~ NA_real_  # default value if none of the conditions match
  ))
```

# 2025 curves
```{r}
DATADIR = "/Users/anjumgujral/Box Sync/yuba-phys_data/P50"

#cavitron_files <- list.files(path = here::here("P50", "P50_individual"), pattern = "*.csv", full.names = TRUE, include.dirs = T, recursive = T) 

cavitron_files_2025 <- c(
  here::here("P50", "p50_8_28_2025.csv"),
  here::here("P50", "p50_9_15_2025.csv")
)

# Read and combine CSV files
all_cavitron_data_2025<- cavitron_files_2025 %>%
  map_dfr(~read_csv(.x, skip = 1, col_names = read_csv(.x, n_max = 1)))

glimpse(all_cavitron_data_2025)
# Assuming you have a combined dataframe called combined_data

# Initialize list to store dataframes
dataframes <- list()

# Track current header and rows under it
current_header <- NULL
current_data <- NULL

some_condition <- function(row) {
  first_cell <- as.character(row[1])
  grepl("Date_time", first_cell, ignore.case = TRUE)
}

for (i in 1:nrow(all_cavitron_data_2025)) {
  row <- all_cavitron_data_2025[i, ]
  
  if (some_condition(row)) {
    # If we're starting a new section, save the previous one first
    if (!is.null(current_data)) {
      df <- setNames(current_data, current_header)
      dataframes <- append(dataframes, list(df))
    }
    
    # Set new header and reset current data
    current_header <- as.character(row)
    current_data <- NULL
    
  } else {
    # Accumulate rows under the current header
    if (!is.null(current_header)) {
      if (is.null(current_data)) {
        current_data <- row
      } else {
        current_data <- bind_rows(current_data, row)
      }
    }
  }
}

# After the loop, dont forget to save the last chunk
if (!is.null(current_data)) {
  df <- setNames(current_data, current_header)
  dataframes <- append(dataframes, list(df))
}

# Now combine all
cavitron_2025_df <- bind_rows(dataframes) %>%
  janitor::clean_names()


vc_all_2025 <- cavitron_2025_df %>%
  janitor::clean_names() %>%
  filter(!is.na(sample_ref_1)) %>%    # Keep only rows with tree IDs
  mutate(tree = as.numeric(sample_ref_1),
         mpa = as.numeric(pressure_mpa) * -1,
         pressures = mpa,
         neg_mpa = as.numeric(pressure_mpa),
        k = as.numeric(raw_conductance_kg_mpa_s),           #raw stem hydraulic conductance
        kstem_length = as.numeric(conductivity_si_corr_t),  #hydraulic conductivity per stem length 
        #stem_id = paste(site, tree, branch, sep = "-"),
        plc_new = as.numeric(plc),
        #species = case_when(
    #species %in% c("Abies concolor") ~ "ABCO", 
    #species %in% c("Pinus lambertiana") ~ "PILA", 
    #species %in% c("Calocedrus decurrens") ~ "CADE", 
    #TRUE ~ as.character(species)), 
    type = case_when(speed_class %in% c("a") ~ "kmax", #maximum conductivity point (from speed class "a")
                     speed_class %in% c("b", "c","d", "e", "f", "g", "h", "i") ~ "VC", 
      TRUE ~ as.character(speed_class))) %>%  # everything else = speed classes "b" to "i")
  select(tree, mpa, neg_mpa, k, kstem_length, plc_new, type) %>% 
  mutate(size = as.factor("B"), 
         plc_new = case_when(  #set bounds for PLC new from 0-100
           plc_new < 0 ~ 0, 
           plc_new > 100 ~ 100,
           TRUE ~ as.numeric(plc_new)
         )) %>% 
  drop_na(plc_new)

vc_all_2025_2 <- vc_all_2025 %>% 
  group_by(tree) %>% 
  mutate(group = case_when(
    mpa == min(mpa) ~ "a",              #if mpa is the minimum mpa for that tree, assign group "a" (kmax)
    TRUE ~ as.character("b"))) %>%      #otherwise assign it to group "b"
  group_by(tree) %>% 
  mutate(mean_kstem_a = mean(kstem_length[group == 'a'], na.rm = T)) %>%  # mean of the kmax values
  ungroup() %>% 
  mutate(plc_new = 100-(100*kstem_length/mean_kstem_a))%>%   #calculate PLC from 
  drop_na(plc_new)

```


```{r}

cavitron_files_2025 <- c(
  here::here("P50", "p50_8_28_2025.csv"),
  here::here("P50", "p50_9_15_2025.csv")
)

# Read both CSVs, skip first line (metadata), use second line as header, combine
cavitron_2025_df <- cavitron_files_2025 %>%
  map_dfr(~ read_csv(.x, skip = 1, col_names = TRUE)) %>%
  janitor::clean_names()

# Now run your data cleaning and transformation pipeline
vc_all_2025 <- cavitron_2025_df %>%
  filter(!is.na(sample_ref_1)) %>%    # Keep only rows with tree IDs
  mutate(tree = as.numeric(sample_ref_1),
         mpa = as.numeric(pressure_mpa) * -1,
         pressures = mpa,
         neg_mpa = as.numeric(pressure_mpa),
         k = as.numeric(raw_conductance_kg_mpa_s),           #raw stem hydraulic conductance
         kstem_length = as.numeric(conductivity_si_corr_t),  #hydraulic conductivity per stem length 
         plc_new = as.numeric(plc),
         type = case_when(
           speed_class %in% c("a") ~ "kmax", #maximum conductivity point (from speed class "a")
           speed_class %in% c("b", "c","d", "e", "f", "g", "h", "i") ~ "VC", 
           TRUE ~ as.character(speed_class)
         )) %>%  
  select(tree, mpa, neg_mpa, k, kstem_length, plc_new, type) %>% 
  mutate(size = as.factor("B"), 
         plc_new = case_when(  #set bounds for PLC new from 0-100
           plc_new < 0 ~ 0, 
           plc_new > 100 ~ 100,
           TRUE ~ as.numeric(plc_new)
         )) %>% 
  drop_na(plc_new)

vc_all_2025_2 <- vc_all_2025 %>% 
  group_by(tree) %>% 
  mutate(group = case_when(
    mpa == min(mpa) ~ "a",              #if mpa is the minimum mpa for that tree, assign group "a" (kmax)
    TRUE ~ "b")) %>%      
  group_by(tree) %>% 
  mutate(mean_kstem_a = mean(kstem_length[group == 'a'], na.rm = TRUE)) %>%  # mean of the kmax values
  ungroup() %>% 
  mutate(plc_new = 100 - (100 * kstem_length / mean_kstem_a)) %>%   #calculate PLC from 
  drop_na(plc_new)

write.csv(vc_all_2025_2, file = "yuba-phys-vulnerability-curve-raw-data-2025.csv", row.names = FALSE)

vc_raw_2025 <- read.csv("yuba-phys-vulnerability-curve-raw-data-2025.csv")

```


```{r}
#Have to do each tree individually and remove the ones that do not work: 

stemID <- subset(vc_raw_2025, vc_raw_2025$tree =="456")
# Convert all numeric columns to avoid scientific notation
#stemID <- stemID %>%
  #mutate(k = format(k, scientific = FALSE))
#pfit <- fitplc(stemID, varnames=c(PLC="plc_new", WP="mpa"), nboot=50)

stemID <- stemID %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  # Create valid_data based on plc_new >= 0

# Fit the model using only rows where plc_new >= 0
pfit <- fitplc(stemID %>% filter(valid_data == TRUE), varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 50)

# Plot the fitted model
plot(pfit, 
     xlim = c(0,9),
     ylim = c(0,1))

# Access the fitted coefficients
coefficients <- coef(pfit)
print(coefficients)


vc_clean_2025 <- bind_rows(vc_clean_2025, stemID)
write.csv(vc_clean_2025, "vc_clean_2025.csv")
```

```{r}
PLC_2025 <- vc_all_2025_2 %>% 
  filter((tree %in% c("465")))

PLC_2025 <- PLC_2025 %>%
  mutate(k = format(k, scientific = FALSE),  # Ensure 'k' is formatted as non-scientific
         valid_data = ifelse(plc_new >= 0, TRUE, FALSE))  

PLC_2025 <- PLC_2025 %>% filter(valid_data == TRUE)

#PLC_2025 <- PLC_2025 %>%
  #slice(1:28)

PLC_2025_cleaned <- 
  PLC_2025 %>%  filter(!row_number() %in% c(5, 8))

PLC_2025_cleaned <- PLC_2025 %>%
  mutate(type = case_when(
    row_number() == 2 ~ "kmax",          #  set row 5 as new kmax
    TRUE ~ type
  ))

# 1. Identify the new kmax value
new_kmax <- PLC_2025_cleaned %>%
  filter(row_number() == 2) %>%  # <- or your specific condition
  pull(k) %>% as.numeric()

# 2. Recalculate PLC using new kmax
PLC_2025_cleaned <- PLC_2025_cleaned %>%
  mutate(
    k = as.numeric(k),  # make sure 'k' is numeric
    plc_new = 100 * (1 - (k / new_kmax)),
    plc_new = case_when(
      plc_new < 0 ~ 0,
      plc_new > 100 ~ 100,
      TRUE ~ plc_new
    )
  )

# Fit the model using only rows where plc_new >= 0
pfit <- fitplcs(PLC_2025_cleaned, "tree", varnames = c(PLC = "plc_new", WP = "mpa"), nboot = 5)

coef(pfit)
plot(pfit,
     onepanel = T, 
     plotci = F, 
     pxlinecol = "black",
     main = "2025 curves",
     legend = TRUE,
     xlim = c(0.5, 8),
     ylim = c(0,1))

coef(pfit) %>% 
  clean_names() %>% 
  filter(parameter == "PX") %>%
  summarise(mean_P50 = mean(estimate), 
            mean_lwr = mean(boot_2_5_percent), 
            mean_upr = mean(boot_97_5_percent))


```

# 2025 cleaned df
```{r}

vc_all_2025_2_cleaned <- data.frame()
vc_all_2025_2_cleaned <- tibble()

PLC_2025_cleaned <- PLC_2025_cleaned %>%
  mutate(k = as.numeric(k))

vc_all_2025_2_cleaned <- bind_rows(vc_all_2025_2_cleaned, PLC_2025_cleaned)

####### DO NOT OVERWRITE THIS CSV ############
write.csv(vc_all_2025_2_cleaned, "vulnerability_curves_cleaned_2025.csv")

vc_clean_2025_1 <- read.csv("vulnerability_curves_cleaned_2025.csv")
vc_clean_2025_1 <- vc_clean_2025_1[, -12]
```

```{r}
# merge two cleaned data frames (vc_clean_2025)

merged_2025_cleaned_vc <- rbind(vc_clean_2025_1, vc_clean_2025)
write.csv(merged_2025_cleaned_vc, "yuba-phys-vulnerability-curve-cleaned-data-2025.csv")

```

#automate through
```{r}
library(dplyr)
library(fitplc)

# load in 2024 and 2024 cleaned hydraulics data
vulnerability_curves_2024 <- read.csv("yuba-phys-vulnerability-curve-cleaned-data-2024.csv")
vulnerability_curves_2025 <- read.csv("yuba-phys-vulnerability-curve-cleaned-data-2025.csv")

# run this for 2024 and 2025 vulnerability curve data

# list of unique tree IDs
tree_ID <- unique(vulnerability_curves_2024$tree)

# empty lists to store results
model_list <- list()
coef_list  <- list()

# loop through 
for (t in tree_ID) {

  # Subset for one tree
  stemID <- vulnerability_curves_2024 %>%
    filter(tree == t) %>%
    mutate(
      k = format(k, scientific = FALSE),
      valid_data = plc_new >= 0
    )

  # skip trees with no valid data
  if (sum(stemID$valid_data) == 0) {
    warning(paste("No valid data for tree", t))
    next
  }

  # fit plc model
  pfit <- fitplc(
    stemID %>% filter(valid_data),
    varnames = c(PLC = "plc_new", WP = "mpa"),
    nboot = 50
  )
  plot(
    pfit,
    xlim = c(0, 7),
    ylim = c(0, 1),
    main = paste("tree ID", t)
  )
  # Store model and coefficients
  model_list[[as.character(t)]] <- pfit
  coef_list[[as.character(t)]]  <- coef(pfit)
}



coef_df <- bind_rows(
  lapply(names(coef_list), function(t) {
    data.frame(
      tree = t,
      t(coef_list[[t]]),
      row.names = NULL
    )
  })
)

print(coef_df)

```


